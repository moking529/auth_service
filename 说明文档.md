# Django 用户认证和授权服务

## 已完成任务

- ✅ 全局.gitignore文件配置
- ✅ 项目文档Python版本要求调整（从3.14.0更改为3.9-3.14.0以同时支持开发环境和服务器环境）
- ✅ 创建了详细的宝塔面板部署指南，包含完整的环境配置、数据库设置、文件上传、静态文件配置、域名绑定、SSL证书安装和测试步骤
- ✅ 根据实际部署截图，优化了宝塔面板中添加Python项目的具体配置参数，包括Python环境、启动方式、通讯协议等详细信息
- ✅ 更新.gitignore文件，添加对examples目录、项目文档目录和debug目录的忽略规则
- ✅ 创建.env环境配置文件，设置生产环境必要参数
- ✅ 添加Redis依赖到requirements.txt
- ✅ 运行数据库迁移和收集静态文件，确保项目可部署
- ✅ 代码覆盖率达到88%，核心模块middleware.py达到100%，cache.py达到98%
- ✅ 系统检查通过，无语法错误
- ✅ 修复Django管理后台访问问题：优化服务认证中间件的路径排除逻辑，确保管理后台能够正常访问

## 项目规划

### 项目概述
开发基于Django + Django REST Framework的用户认证和授权服务，实现用户注册、登录、JWT认证、权限控制等功能。

### 功能概述
- 用户注册、登录和JWT认证
- 细粒度权限管理（基于资源类型和操作类型）
- 权限组管理
- API权限检查服务
- 用户配置文件管理
- 日志记录系统

### 技术栈
- **后端框架**：Django 5.2.7、Django REST Framework 3.14+
- **认证授权**：JWT (JSON Web Token)，access_token有效期2小时、refresh_token有效期7天
- **数据库**：开发环境和测试环境使用SQLite，生产环境使用PostgreSQL
- **缓存系统**：Redis（已启用，CACHE_ENABLED = True）
- **后端语言**：Python 3.9-3.14.0
- **部署方式**：Python虚拟环境部署（支持Linux和Windows操作系统）

### 时间规划
- 项目启动：2024年
- 需求分析：1天
- 开发阶段：3天
- 测试阶段：1天
- 完成交付：总计5天

## 实施方案

### 核心功能
1. **用户注册**
   - 支持输入用户名、密码、手机号（可选）、角色（默认普通用户，可选管理员）
   - 密码自动加密存储

2. **用户登录**
   - 输入用户名 + 密码
   - 返回JWT令牌（access_token有效期2小时，refresh_token有效期7天）

3. **令牌刷新**
   - 使用refresh_token获取新的access_token

4. **用户信息获取**
   - 登录后查询自身信息
   - 令牌有效性验证

5. **权限控制**
   - 普通用户：只能查看自己的信息
   - 管理员：可以查看所有用户列表

6. **静态文件服务**
   - 支持静态文件收集和访问
   - 配置优化的缓存策略

### 项目结构设计
```
g:\企业直播管理系统\权限分配\
├── auth_service/          # Django项目配置目录
├── users/                 # 用户应用
│   ├── migrations/        # 数据库迁移文件
│   ├── admin.py           # Django admin配置
│   ├── apps.py            # 应用配置
│   ├── cache.py           # Redis缓存服务
│   ├── middleware.py      # 中间件
│   ├── models.py          # 数据模型
│   ├── permission_logger.py # 权限日志记录
│   ├── permissions.py     # 权限类
│   ├── serializers.py     # 序列化器
│   ├── tests.py           # 应用测试
│   ├── urls.py            # 应用URL配置
│   └── views.py           # 视图函数
├── tests/                 # 测试目录
├── debug/                 # 调试脚本
├── examples/              # 示例代码
├── logs/                  # 日志目录
├── manage.py              # Django管理脚本
├── requirements.txt       # 依赖包列表
├── README.md              # 项目文档
├── 说明文档.md           # 项目说明文档
└── .env                   # 环境配置文件
```

## 进度记录

### 已完成任务
- [x] 创建Django项目
- [x] 配置项目环境和依赖
- [x] 实现用户模型
- [x] 实现用户注册功能
- [x] 实现用户登录功能
- [x] 实现JWT认证配置
- [x] 实现令牌刷新功能
- [x] 实现用户信息获取功能
- [x] 实现权限控制
- [x] 运行数据库迁移
- [x] 创建超级用户
- [x] 编写API测试文档
- [x] 启动开发服务器并验证功能
- [x] 实现Redis缓存服务
- [x] 实现权限日志记录功能
- [x] 项目结构优化与整理
  - [x] 创建debug目录存放调试脚本
  - [x] 创建examples目录存放示例代码
  - [x] 清理__pycache__文件和临时文件
  - [x] 创建标准README.md文档
  - [x] 更新项目结构文档
  - [x] 移除冗余文件和目录
- [x] 虚拟环境部署配置完成
- [x] 创建环境配置文件(.env)
- [x] 更新依赖配置，添加Redis支持
- [x] 运行静态文件收集 (python manage.py collectstatic --noinput)
- [x] 配置静态文件服务和Nginx静态资源代理
- [x] 优化测试用例，提高代码覆盖率（达到88%）
- [x] 系统检查通过，无语法错误

### 当前状态
- 开发环境测试全部通过（91个测试用例）
- 代码覆盖率达到88%，核心模块middleware.py达到100%，cache.py达到98%
- Redis缓存已启用（CACHE_ENABLED = True）
- 系统支持Linux和Windows环境下的虚拟环境部署
- 已配置环境变量管理系统，包含生产环境必要配置
- 提供Linux和Windows版本的一键启动脚本
- 使用SQLite数据库
- 项目已准备就绪，可以上传至服务器部署

## 项目总结

已成功完成Django+DRF用户认证和授权服务的开发，包含以下核心功能：

1. 用户注册：支持用户名、密码、手机号、邮箱和角色设置
2. 用户登录：返回JWT令牌（access_token有效期2小时，refresh_token有效期7天）
3. 令牌刷新：使用refresh_token获取新的access_token
4. 用户信息获取：登录后可查询个人信息
5. 权限控制：区分普通用户和管理员角色权限

项目已完成全部开发和部署准备工作，包括：
- 创建并配置环境变量文件
- 添加必要的依赖包
- 运行数据库迁移和收集静态文件
- 系统检查通过无错误
- 代码覆盖率达到88%

系统已准备就绪，可以按照宝塔面板部署指南进行服务器部署。

## 宝塔面板部署补充说明

### 项目配置

1. 在项目根目录创建`.env`文件：
   ```
   # 基本配置
   DEBUG=False
   SECRET_KEY=your_secret_key_here  # 生成一个随机的密钥
   ALLOWED_HOSTS=your-domain.com,www.your-domain.com
   
   # 数据库配置
   DATABASE_URL=postgres://auth_service_user:your_password@localhost:5432/auth_service_db
   # 或MySQL配置
   # DATABASE_URL=mysql://auth_service_user:your_password@localhost:3306/auth_service_db
   
   # Redis配置
   REDIS_CONFIG_HOST=localhost
   REDIS_CONFIG_PORT=6379
   REDIS_CONFIG_PASSWORD=your_redis_password
   REDIS_CONFIG_DB=0
   CACHE_ENABLED=True
   
   # JWT配置
   ACCESS_TOKEN_LIFETIME=2  # 小时
   REFRESH_TOKEN_LIFETIME=7  # 天
   ```

2. **静态文件配置**：确保`auth_service/settings.py`文件中包含以下静态文件配置：
   ```python
   # Static files (CSS, JavaScript, Images)
   # https://docs.djangoproject.com/en/5.2/howto/static-files/
   
   STATIC_URL = '/static/'
   STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
   
   # 静态文件目录列表
   STATICFILES_DIRS = [
       os.path.join(BASE_DIR, 'static'),
   ]
   
   # 静态文件查找器
   STATICFILES_FINDERS = [
       'django.contrib.staticfiles.finders.FileSystemFinder',
       'django.contrib.staticfiles.finders.AppDirectoriesFinder',
   ]
   ```

3. **收集静态文件**：
   - 在终端中输入：`python manage.py collectstatic --noinput`
   - 这将把所有静态文件收集到`staticfiles`目录中

### 配置反向代理和静态文件服务

1. 配置反向代理：
   - 在刚创建的网站右侧，点击`设置`
   - 选择`反向代理`，点击`添加反向代理`
   - 填写以下信息：
     - 代理名称：`auth_service`
     - 目标URL：`http://127.0.0.1:8000`（与Python项目管理器中设置的端口一致）
     - 发送域名：选择`$host`
     - 启用Websocket：勾选
   - 点击`保存`

2. 配置静态文件服务：
   - 在网站设置中，点击`配置文件`
   - 在Nginx配置文件中，在`location /`块之前添加以下静态文件配置：
     ```nginx
     # 静态文件配置
     location /static/ {
         alias /www/wwwroot/auth_service/staticfiles/;
         expires 30d;
         access_log off;
     }
     ```
   - 点击`保存`并重启Nginx服务

### 常见问题解决

**静态文件无法访问**
- **检查**：
  1. 确认已运行`collectstatic --noinput`命令
  2. 检查静态文件目录权限是否为755
  3. 确认Nginx配置中包含正确的静态文件路径
  4. 检查Django settings.py中的静态文件配置是否正确
  5. 确保中间件中已排除静态文件路径的认证检查
- **解决**：
  1. 重新运行`collectstatic --noinput`命令
  2. 在文件管理器中设置静态文件目录权限为755
  3. 在Nginx配置中添加静态文件规则
  4. 确保settings.py中的STATIC_ROOT和STATIC_URL配置正确
  5. 确保中间件中的EXCLUDED_PATHS列表包含'/static/'路径